<!--
Welcome to the Live Bar Graph!
-----------------------------------
This app brings your Google Sheet data to life, showing people and their times with live-updating bars.
You can pause or resume timers, export the current times, and even customize colors to make it feel just right.
It's simple, interactive, and designed to make tracking competitive, fun and easy! ;)
-->

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Live Bar Graph with Google Sheets Integration</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0; padding: 0;
    background: #fafafa;
    color: #222;
    user-select: none;
  }
  .top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    background: #e2e8f0;
    border-bottom: 2px solid #cbd5e1;
    flex-wrap: wrap;
    font-size: 18px;
  }
  .clock {
    font-weight: 700;
    margin-left: auto;
    margin-right: 15px;
    font-size: 20px;
    color: #2d3748;
  }
  .container {
    max-height: 80vh;
    overflow-y: auto;
    padding: 20px 25px;
    background: #fff;
    box-shadow: 0 4px 12px rgb(0 0 0 / 0.05);
    border-radius: 12px;
    margin: 20px auto;
    max-width: 700px;
  }
  .row {
    display: flex;
    align-items: center;
    margin-bottom: 18px;
    gap: 15px;
    transition: transform 0.5s ease;
  }
  .name-container {
    width: 170px;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
  }
  .person-image {
    height: 40px;
    width: 40px;
    object-fit: contain;
    border-radius: 8px;
    border: 1.5px solid #cbd5e1;
    background: #f0f4f8;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    transition: box-shadow 0.3s ease;
  }
  .person-image:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    cursor: default;
  }
  .name {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-weight: 700;
    font-size: 20px;
    color: #2d3748;
  }
  .bar-time-container {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-grow: 1;
    min-width: 0;
    transition: order 0.5s ease;
  }
  .bar {
    height: 28px;
    background: #87ceeb;
    transition: width 0.5s ease, background-color 0.3s ease;
    cursor: pointer;
    border-radius: 14px;
    flex-shrink: 1;
    box-shadow: inset 0 1px 3px rgba(255 255 255 / 0.6);
    min-width: 10px;
  }
  .time-label {
    width: 90px;
    text-align: right;
    font-variant-numeric: tabular-nums;
    font-weight: 600;
    font-size: 18px;
    color: #4a5568;
    flex-shrink: 0;
    white-space: nowrap;
    user-select: none;
  }
  .controls {
    display: flex;
    gap: 12px;
    flex-shrink: 0;
  }
  button {
    background: #4299e1;
    border: none;
    padding: 8px 16px;
    border-radius: 14px;
    font-size: 16px;
    color: white;
    font-weight: 600;
    box-shadow: 0 4px 10px rgb(66 153 225 / 0.4);
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
  }
  button:hover {
    background: #2b6cb0;
    box-shadow: 0 6px 14px rgb(43 108 176 / 0.6);
  }
  button:active {
    background: #2c5282;
    box-shadow: 0 2px 6px rgb(44 82 130 / 0.7);
  }
  .color-controls {
    display: flex;
    gap: 18px;
    align-items: center;
    flex-wrap: wrap;
    margin-top: 8px;
    margin-bottom: 8px;
    font-size: 16px;
    color: #2d3748;
  }
  .color-controls label {
    user-select: none;
  }
  .color-controls input[type=color] {
    cursor: pointer;
    border: none;
    width: 34px;
    height: 30px;
    padding: 0;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgb(0 0 0 / 0.15);
    transition: box-shadow 0.3s ease;
  }
  .color-controls input[type=color]:hover {
    box-shadow: 0 3px 8px rgb(0 0 0 / 0.25);
  }
  #colorPickerPopup {
    position: fixed;
    display: none;
    z-index: 1000;
    background: #fff;
    border: 1.5px solid #cbd5e1;
    padding: 7px 10px;
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.1);
  }
  #colorPickerPopup input[type=color] {
    width: 50px;
    height: 40px;
    border-radius: 12px;
  }
</style>
</head>
<body>
  <div class="top-bar">
    <div>
      <button onclick="pauseAll()">Clock OutAll</button>
      <button onclick="resumeAll()">Clock In All</button>
      <button onclick="exportTimes()">Export Times</button>
    </div>
    <div class="color-controls">
      <label>Background: <input type="color" id="bgColorPicker" value="#fafafa" onchange="changeBackgroundColor(this.value)"/></label>
      <label>Bar Color: <input type="color" id="barColorPicker" value="#87ceeb" onchange="changeAllBarColors(this.value)"/></label>
    </div>
    <div class="clock" id="clock"></div>
  </div>
  <div class="container" id="container"></div>

  <div id="colorPickerPopup">
    <input type="color" id="individualColorInput" />
  </div>

  <script>
    const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTo0Oy7yuI3NFADTcVTMnqYlXPf584j6tJmGeRCDRRD4Df3_-iRvRXu-qS9sFoGx-j7QHIAOCNl1Q-H/pub?output=csv';

    let entries = {};
    let personImages = {};

    let pausedPeople = new Set();
    let globalPaused = false;

    const container = document.getElementById("container");
    const bgColorPicker = document.getElementById("bgColorPicker");
    const barColorPicker = document.getElementById("barColorPicker");
    const colorPickerPopup = document.getElementById("colorPickerPopup");
    const individualColorInput = document.getElementById("individualColorInput");

    let rows = {};
    let barColors = {};

    const MAX_BAR_WIDTH = 350;
    let currentColorBar = null;

    // Format time into h m s string
    function formatTime(seconds) {
      seconds = Math.floor(seconds);
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      let result = "";
      if (h > 0) result += h + "h ";
      if (m > 0) result += m + "m ";
      if (s > 0 || seconds === 0) result += s + "s";
      return result.trim();
    }

    // Update the live clock
    function updateClock() {
      const now = new Date();
      document.getElementById("clock").textContent = now.toLocaleTimeString();
    }

    // Initialize rows UI
    function initRows() {
      container.innerHTML = "";
      rows = {};
      barColors = {};
      for (let name in entries) {
        const row = document.createElement("div");
        row.className = "row";
        row.dataset.name = name;

        // Name + image container
        const nameContainer = document.createElement("div");
        nameContainer.className = "name-container";

        const img = document.createElement("img");
        img.className = "person-image";
        img.src = personImages[name] || "";
        img.alt = name;

        const nameLabel = document.createElement("div");
        nameLabel.className = "name";
        nameLabel.textContent = name;

        nameContainer.appendChild(img);
        nameContainer.appendChild(nameLabel);
        row.appendChild(nameContainer);

        // Bar and time label container (overtaking effect)
        const barTimeContainer = document.createElement("div");
        barTimeContainer.className = "bar-time-container";

        const bar = document.createElement("div");
        bar.className = "bar";
        bar.style.backgroundColor = barColorPicker.value;
        barColors[name] = barColorPicker.value;
        bar.style.width = "1px";
        barTimeContainer.appendChild(bar);

        const timeLabel = document.createElement("div");
        timeLabel.className = "time-label";
        timeLabel.textContent = "0s";
        barTimeContainer.appendChild(timeLabel);

        row.appendChild(barTimeContainer);

        // Controls container
        const controls = document.createElement("div");
        controls.className = "controls";

        const pauseBtn = document.createElement("button");
        pauseBtn.textContent = "Clock Out";
        pauseBtn.onclick = () => pausedPeople.add(name);
        controls.appendChild(pauseBtn);

        const resumeBtn = document.createElement("button");
        resumeBtn.textContent = "Clock In";
        resumeBtn.onclick = () => pausedPeople.delete(name);
        controls.appendChild(resumeBtn);

        row.appendChild(controls);

        // Bar click opens color picker
        bar.addEventListener("click", (e) => {
          e.stopPropagation();
          openColorPickerForBar(name, bar);
        });

        container.appendChild(row);

        rows[name] = { row, bar, timeLabel, barTimeContainer };
      }
    }

    // Update bars and reorder rows vertically by time (overtaking effect)
    function updateBars() {
      for (let name in entries) {
        if (!globalPaused && !pausedPeople.has(name)) {
          entries[name]++;
        }
      }

      // Sort names by descending time for vertical order
      let sortedNames = Object.keys(entries).sort((a, b) => entries[b] - entries[a]);
      let maxTime = Math.max(...Object.values(entries), 1);

      // Reorder rows vertically in container
      sortedNames.forEach(name => {
        container.appendChild(rows[name].row);
      });

      // Update bars width & time label
      sortedNames.forEach((name) => {
        const { bar, timeLabel } = rows[name];
        let scaledWidth = Math.max(10, Math.round((entries[name] / maxTime) * MAX_BAR_WIDTH));
        bar.style.width = scaledWidth + "px";
        bar.style.backgroundColor = barColors[name];
        timeLabel.textContent = formatTime(entries[name]);
      });
    }

    // Change background color of body and container
    function changeBackgroundColor(color) {
      document.body.style.backgroundColor = color;
      container.style.backgroundColor = color;
    }

    // Change all bars' colors to one selected color
    function changeAllBarColors(color) {
      for (let name in barColors) {
        barColors[name] = color;
        if (rows[name]) {
          rows[name].bar.style.backgroundColor = color;
        }
      }
      barColorPicker.value = color;
    }

    // Pause all bars
    function pauseAll() {
      globalPaused = true;
    }

    // Resume all bars
    function resumeAll() {
      globalPaused = false;
    }

    // Export current times as CSV
    function exportTimes() {
      let csv = "Name,Seconds\n";
      for (let name in entries) {
        csv += `${name},${entries[name]}\n`;
      }
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "times.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    // Open color picker popup next to bar
    function openColorPickerForBar(name, barElement) {
      currentColorBar = name;
      individualColorInput.value = barColors[name] || barColorPicker.value;

      const rect = barElement.getBoundingClientRect();
      colorPickerPopup.style.top = (rect.bottom + window.scrollY + 5) + "px";
      colorPickerPopup.style.left = (rect.left + window.scrollX) + "px";
      colorPickerPopup.style.display = "block";

      individualColorInput.focus();
    }

    // Close color picker popup
    function closeColorPicker() {
      colorPickerPopup.style.display = "none";
      currentColorBar = null;
    }

    // Handle color change for individual bar
    individualColorInput.addEventListener("input", () => {
      if (currentColorBar) {
        barColors[currentColorBar] = individualColorInput.value;
        if (rows[currentColorBar]) {
          rows[currentColorBar].bar.style.backgroundColor = individualColorInput.value;
        }
      }
    });

    // Close popup if click outside
    document.body.addEventListener("click", (e) => {
      if (!colorPickerPopup.contains(e.target)) {
        closeColorPicker();
      }
    });

    colorPickerPopup.addEventListener("click", e => {
      e.stopPropagation();
    });

    // Fetch CSV data and parse it
    async function fetchDataFromSheet() {
      try {
        const res = await fetch(GOOGLE_SHEET_CSV_URL + '&cache=' + new Date().getTime());
        if (!res.ok) throw new Error("Network response was not ok");
        const csvText = await res.text();

        const lines = csvText.trim().split(/\r?\n/);
        if (lines.length < 2) {
          console.error("CSV data is empty or incomplete");
          return;
        }
        const headers = parseCSVLine(lines[0]);

        const idxName = headers.indexOf('Name');
        const idxTime = headers.indexOf('TimeSeconds');
        const idxImage = headers.indexOf('ImageURL');

        if (idxName === -1 || idxTime === -1 || idxImage === -1) {
          console.error("CSV headers missing required columns");
          return;
        }

        let newEntries = {};
        let newImages = {};

        for (let i = 1; i < lines.length; i++) {
          const row = parseCSVLine(lines[i]);
          if (row.length < headers.length) continue; // skip incomplete rows

          const name = row[idxName]?.trim() || "";
          const timeRaw = row[idxTime]?.trim() || "0";
          const image = row[idxImage]?.trim() || "";
          const time = parseInt(timeRaw, 10);

          if (name) {
            newEntries[name] = isNaN(time) ? 0 : time;
            newImages[name] = image;
          }
        }

        // Detect changes in entries or images
        let changed = false;

        // Add new or update existing entries/images
        for (const name in newEntries) {
          if (!(name in entries) || entries[name] !== newEntries[name]) {
            entries[name] = newEntries[name];
            changed = true;
          }
          if (!(name in personImages) || personImages[name] !== newImages[name]) {
            personImages[name] = newImages[name];
            changed = true;
          }
        }

        // Remove any entries/images not in new data
        for (const name in entries) {
          if (!(name in newEntries)) {
            delete entries[name];
            delete personImages[name];
            changed = true;
          }
        }

        if (changed) {
          initRows();
        }

      } catch (err) {
        console.error("Failed to fetch or parse sheet:", err);
      }
    }

    // CSV line parser supporting quoted commas
    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          if (inQuotes && line[i+1] === '"') {
            current += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (char === ',' && !inQuotes) {
          result.push(current);
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current);
      return result;
    }

    // Periodic updates every second
    setInterval(() => {
      updateClock();
      updateBars();
    }, 1000);

    // Poll Google Sheet every 24hrs for updates
    setInterval(fetchDataFromSheet, 8.64e+7);

    // Initial fetch and setup
    fetchDataFromSheet();

  </script>
</body>
</html>



